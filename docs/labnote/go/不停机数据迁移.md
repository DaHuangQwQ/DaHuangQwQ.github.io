# 不停机数据迁移

> 难点是数据始终在变化

## 不停机数据迁移的四个方案

1. 第一阶段：业务读写源表
2. 第二阶段：双写阶段，以源表为准
3. 第三阶段：双写阶段，以目标表为准
4. 第四阶段：业务读写目标表

## 不停机数据迁移的具体步骤

1. 初始化目标表结构

2. 用源表的数据初始化目标表

   > mysql指令复制数据：mysqldump

3. 执行一次校验，并且修复数据，此时用源表数据修复目标表数据

4. 业务代码开启双写，此时读源表，并且先写源表，数据以源表为准。

5. 开启增量校验和数据修复，保持一段时间

6. 切换双写顺序，此时读目标表，并且先写目标表，数据以目标表为准

7. 继续保持增量校验和数据修复

8. 切换为目标表单写，读写都只操作目标表

   > 双写阶段要保持增量校验，偶尔执行全量校验

## 注意事项

1.  失败了 等校验和恢复程序
2.  校验的时候，先读从库，如果从库数据不一致，再度主库校验一遍
3.  为什么用 kafka？ 削峰 异步 解藕， 批量接口优化
4.  流量录制与重放，复制请求到 老系统和新系统 比较响应（顶尖大厂才可能做出来，面试官不会相信你做出来）
5.  在 GORM 中，运用装饰器模式来装饰 原表和目标表的 ConnPool，可以实现 双写、读写分离、分库分表等功能