# 缓存

## 缓存模式

### Cache Aside

- 把 Cache 当成一个普通的数据源
- 更新 Cache 和 DB 都依赖于开发者自己写代码

**业务代码**可以做决策:

- 未命中的时候是否要从 DB 取数据。如果不从 DB 取，可以考虑使用默认值进行业务处理
- 同步 or 异步读取数据并且写入
- 采用 singleflight

### Read Through

- 业务代码只需要从 cache 中读取数据，cache 会在缓存不命中的时候去读取数据
- 写数据的时候，业务代码需要自己写 DB 和写 cache

**cache** 可以做决策:

- 未命中的时候是否要从 DB 取数据。如果不从 DB 取，可以考虑使用默认值进行业务处理

- 同步 or 异步读取数据并且写入
- 采用 singleflight

### Write Through

- 开发者只需要写入 cache，cache 自己会更新数据库
- 在读未命中缓存的情况下，开发者需要自己去数据库捞数据，然后更新缓存(此时缓存不需要更新 DB 了)

### Write Back

- 在写操作的时候写了缓存直接返回，不会直接更新数据库，读也是直接读缓存
- 在缓存过期的时候，将缓存写回去数据库
- 所有 goroutine 都是读写缓存，不存在一致性的问题(如果是本地缓存依旧会有问题)
- 数据可能丢失:如果在缓存过期刷新到数据库之前，缓存宕机，那么会丢失数据

### Refresh Ahead

refresh-ahead 依赖于 CDC(changed data capture) 接口: • 数据库暴露数据变更接口

- cache 或者第四方在监听到数据变更之后自动更新数据
- 如果读 cache 未命中，依旧要刷新缓存的话，依然会出现并发问题