# 链路数据传递和 HINT 机制

HINT 其实是我们自己定义的一种语法，用来**传递上下文信息**，这些上下文信息取决于具体的业务场景。我举几个例子：

- AB 测试；
- 全链路追踪，也就是所谓的 trace id。有一些公司有自己的标准，他们可能需要传递 transaction id，也就是 tid。通过这个 trace id，就可以将一个请求从 web 到 service，再到 dbproxy 的整个链条都串起来；
- 全链路压测，也就是借助 HINT 来传递当前查询是测试请求的查询，还是线上请求的查询，从而决定将请求转发到哪一个数据库；

除了这些功能，还有一些 dbproxy 本身的功能也要借助这个 HINT 来实现：

- 强制走主库：要用 HINT 来告诉 dbproxy；
- 使用何种跨库事务，也要 HINT 来告诉 dbproxy；

而 HINT 的语法也很简单，就是一种特殊格式的 SQL 注释而已。例如前面几个例子：

- /* @ab_test a */: 表明这是AB 测试中的 A
- /* @shadow true */: 表明这里全链路测试中的测试请求的查询
- /* @use_master true*/: 表明这是强制走主库

HINT 是我们设计的一种携带查询上下文信息的机制，它的本质就是一种特殊格式的注释。

我们在设计的时候，就考虑到需要携带上下文信息，所以在 ANTLR 里面定义了 HINT 的语法。在我们的预期中，HINT 主要解决的场景包括 AB 测试，链路追踪，全链路压测等。

当然，我们 dbproxy 本身也用 HINT 来支持了一些特定的功能，比如说在读写分离之后，要指定强制走主库，是通过 HINT 来传递的。在开启数据库事务的时候，如果不希望使用默认的延迟事务，那么也需要借助 HINT 来传递事务信息。

## 链路数据传递

## HINT 机制的设计与实现

## 使用 HINT 机制传递 trace id

